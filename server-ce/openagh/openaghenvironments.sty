% \NeedsTexFormat{LaTeX2e}
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{openaghenvironments}[2022/01/12 Styled environments for OPENAGH - open e-books system]

\RequirePackage{amsfonts}
\RequirePackage{hyperref}
\RequirePackage{amsmath}
\RequirePackage{mdframed}
\RequirePackage{graphicx}
\RequirePackage{svg}
\RequirePackage{xcolor}
\RequirePackage{import}
\RequirePackage{qrcode}
\RequirePackage{xkeyval}
%\RequirePackage{epstopdf} % REMOVE BEFORE PUBLISHING
\RequirePackage[export]{adjustbox}
\RequirePackage{showlabels} % DEBUG LABLES PACKAGE
% \RequirePackage{biblatex} % BIBLATEX ERROR ON MAKE4HT
\RequirePackage{float}
\RequirePackage[normalem]{ulem}
\RequirePackage{listings}
% Support packages for LuaLatex and SVG
\RequirePackage{environ}
\RequirePackage{ifluatex}
\ifluatex
  \RequirePackage{pdftexcmds}
  \makeatletter
  \let\pdfstrcmp\pdf@strcmp
  \let\pdffilemoddate\pdf@filemoddate
  \makeatother
\fi
% \RequirePackage{svg}

%Code listing style named "mystyle"
\lstdefinestyle{mystyle}{captionpos=b}

%"mystyle" code listing set
\lstset{style=mystyle}

\DeclareOption{pl}{\RequirePackage{openaghplcaptions}}
\DeclareOption{eng}{\RequirePackage{openaghengcaptions}}
\DeclareOption*{\PackageWarning{openaghenvironments}{Unknown '\CurrentOption'}}
\ProcessOptions\relax

% \graphicspath{{./media/}}
\renewcommand{\figurename}{Rysunek}
\newcommand{\figurenameabbr}{Rys.}
\renewcommand{\tablename}{Tabela}
% \environbodyname\environbody
%\epstopdfDeclareGraphicsRule{.pdf}{png}{.png}{convert #1 \OutputFile} % REMOVE BEFORE PUBLISHING
%\DeclareGraphicsExtensions{.png,.pdf} % REMOVE BEFORE PUBLISHING

% \addbibresource{./parts/sample.bib} %Import the bibliography file
% \addbibresource{./parts/empty.bib} %Import the bibliography file

%\import{parts/}{keyword_args.tex}
% ######## CREATE A PACKAGE? ##########
\makeatletter
\define@key{openagh@keys}{title}{\def\openagh@title{#1}} % tytuł otoczenia głównie te które
\define@key{openagh@keys}{label}{\def\openagh@label{#1}} % nazwa kotwicy (opjconalna) wszystkie otoczenia
\define@key{openagh@keys}{file}{\def\openagh@file{#1}} % ścieżka do pliku
\define@key{openagh@keys}{iframeLink}{\def\openagh@iframeLink{#1}} % Link do iframe
\define@key{openagh@keys}{alt}{\def\openagh@alt{#1}} % tekst alternatywny obrazka
\define@key{openagh@keys}{altImg}{\def\openagh@altImg{#1}} % ścieżka do obrazka zastępczego
\define@key{openagh@keys}{altImgText}{\def\openagh@altImgText{#1}} % tekst alternatywny obrazka zastępczego
%\define@key{openagh@keys}{altImgCaption}{\def\openagh@altImgCaption{#1}} % podpis obrazka zastępczego
\define@key{openagh@keys}{caption}{\def\openagh@caption{#1}} % podpis tabeli, obrazka, kodu
\define@key{openagh@keys}{link}{\def\openagh@link{#1}} %
\define@key{openagh@keys}{width}{\def\openagh@width{#1}} % szerokość
\define@key{openagh@keys}{height}{\def\openagh@height{#1}} % wysokość
\define@key{openagh@keys}{quality}{\def\openagh@quality{#1}} % jakość
\define@key{openagh@keys}{align}{\def\openagh@align{#1}} % wyrównanie (prawo, środek, lewo)
\define@key{openagh@keys}{linkLabel}{\def\openagh@linkLabel{#1}} % tekst w linku
\define@key{openagh@keys}{handbookId}{\def\openagh@handbookId{#1}} % id podrecznika
\define@key{openagh@keys}{moduleId}{\def\openagh@moduleId{#1}} % id modulu
\define@key{openagh@keys}{refName}{\def\openagh@refName{#1}} % kotwica do której chcemy się odwołać
%\define@key{openagh@keys}{fileAuthors}{\def\openagh@fileAuthors{#1}} % autorzy
%\define@key{openagh@keys}{fileLicence}{\def\openagh@fileLicence{#1}} % licencja
%\define@key{openagh@keys}{fileLicence}{\def\openagh@fileLicence{#1}} % licencja
\makeatother

% \import{parts/}{project_variables.tex}
%\import{parts/}{pl_captions.tex}
% ######## CMD LINE ARGUMENTS? ######## 
% \newcommand\modid{1}
% \newcommand\handbookid{1}
% ######## CREATE A PACKAGE? ##########
\newcommand\openaghmodelcap{Model}
\newcommand\openaghalgorithmcap{Algorytm}
\newcommand\openaghpropertycap{Własność}
\newcommand\openaghannotationcap{Uwaga}
\newcommand\openaghinformationcap{Informacja dodatkowa}
\newcommand\openaghconclusioncap{Wniosek}
\newcommand\openaghsummarycap{Podsumowanie}
\newcommand\openaghexercisecap{Zadanie}
\newcommand\openaghexecontentcap{Treść zadania}
\newcommand\openaghexesolutioncap{Rozwiązanie}
\newcommand\openaghexamplecap{Przykład}
\newcommand\openaghderivationcap{Wyprowadzenie}
\newcommand\openaghtheoremcap{Twierdzenie}
\newcommand\openaghassumptionscap{Założenie}
\newcommand\openaghthesiscap{Teza}
\newcommand\openaghrulecap{Zasada}
\newcommand\openaghlawcap{Prawo}
\newcommand\openaghdefinitioncap{Definicja}
\newcommand\openaghlemmacap{Lemat}
\newcommand\openaghsimulationcap{Symulacja}
\newcommand\openaghlicencecap{Licencja}
\newcommand\openaghauthorcap{Autor}
\newcommand\openaghlistingcap{Listing}
\newcommand\bibtitle{Bibliografia}

% ######### TO DO: ############
% - Image width, height attributes handling
% - Combine strings to translation into one file
% - svg image adjust

% ######### CONSTANTS #########
%\newcommand\openaghdomain{}
\newcommand{\openaghpackagedir}{/usr/local/texlive/texmf-local/tex/latex/openagh}
\newcommand{\openaghdomain}{https://epodreczniki.open.agh.edu.pl}
\newcommand{\openaghreaderroute}[2]{\openaghdomain/handbook/#1/module/#2/reader}
\newcommand{\openaghreaderlink}[3][\handbookid]{\href{\openaghreaderroute{#1}{#2}}{#3}}

% There is problem that I dont know how to overcome. I have to pass Lua variables to LaTeX command inside \directlua.
% Fast solution is to create a Lua function that is doing same thing as LaTeX \openaghreaderroute.
% Defined Lua function near LaTeX command to rememebr that it has to be changed when \openaghreaderroute is changed.
\directlua{%
	function openagh_reader_route(handbook_id, module_id)
		% -- Returns link to reader by module and handbook id 
		local openagh_domain = "\openaghdomain"
		
		return openagh_domain .. "/handbook/" .. handbook_id .. "/module/" .. module_id .. "/reader"
	end

	function openagh_env_ref_caption(target_obj, target_cnt, link_label, is_target_cnt_visible)
		% -- Returns default label for links
		local targets_abbrv = { ["openaghtable"] = "\tablename", ["openaghimg"] = "\figurenameabbr" }
		local target_cnt = target_cnt or ""

		if(not is_target_cnt_visible) then
			target_cnt = ""
		end

		if(not (link_label == "false")) then
			return link_label
		end

		if(targets_abbrv[target_obj] == nil) then
			if(is_target_cnt_visible) then
				return "(" .. target_cnt .. ")"
			end

			return ""
		end
		
		return targets_abbrv[target_obj] .. " " .. target_cnt
	end

	function openagh_include_image(position, width, height, file)
		% -- Returns image based on extension
		% -- local latex_command = "" 
		local include_command = "includegraphics"
		local include_args = ""
		local position_arg = ""
		local file_name = file
		local ext = file:sub(-4)
		local is_svg = ext == ".svg"

		if(is_svg) then
			include_command = "includesvg"
			file_name = file:sub(1, -5)
		end

		if position == "left" or position == "right" then
			position_arg = position
		else
			position_arg = "center"
		end

		if not (is_empty(width)) then
			include_args = include_args .. "width=" .. width
		end

		if not (is_empty(height)) then
			if not include_args == "" then
				include_args = include_args .. ","
			end

			include_args = include_args .. "height=" .. height
		end

		if not (is_svg == true) then
			if not (include_args == "") then
				include_args = include_args .. ","
			end

			include_args = include_args .. position_arg
		end

		return "\noexpand\\" .. include_command .. "[" .. include_args .. "]{" .. file_name .. "}"
	end

	function is_empty(s)
		return s == nil or s == ''
	end

	function is_module_private(module_id)
		return not(private_handbook_modules[module_id] == nil)
	end
}

% Due to cross referencing system there has to be two types of counters:
% 	- global - counts all occurences of specific environment in docuemnt
% 	- module - counts occurences of specific environment in one module
% 
% For example if we will build chapter from two modules global counter will 
% store number of all occurences of openaghlemmas while module counter will
% store number of occurences of opneaghlemmas in specific module.
% 
% ######### COUNTERS GLOBAL #########
\newcounter{openaghlemma}
\newcounter{openaghdefinition}
\newcounter{openaghlaw}
\newcounter{openaghrule}
\newcounter{openaghtheorem}
\newcounter{openaghexample}
\newcounter{openaghexercise}
\newcounter{openaghsummary}
\newcounter{openaghconclusion}
\newcounter{openaghinformation}
\newcounter{openaghannotation}
\newcounter{openaghproperty}
\newcounter{openaghalgorithm}
\newcounter{openaghmodel}
\newcounter{openaghsimulation}
\newcounter{openaghvimeo}
\newcounter{openaghyoutube}
\newcounter{openaghvideo}
\newcounter{openaghimg}
\newcounter{openaghtable}
\newcounter{openaghlisting}
\newcounter{openaghtmpcounter} % used for keeping previous value of counter
\newcounter{openaghequation}
% \newcounter{testcounterone}
% \newcounter{testcountertwo}

% ######### COUNTERS MODULE #########
\newcounter{openaghmodulelemma}
\newcounter{openaghmoduledefinition}
\newcounter{openaghmodulelaw}
\newcounter{openaghmodulerule}
\newcounter{openaghmoduletheorem}
\newcounter{openaghmoduleexample}
\newcounter{openaghmoduleexercise}
\newcounter{openaghmodulesummary}
\newcounter{openaghmoduleconclusion}
\newcounter{openaghmoduleinformation}
\newcounter{openaghmoduleannotation}
\newcounter{openaghmoduleproperty}
\newcounter{openaghmodulealgorithm}
\newcounter{openaghmodulemodel}
\newcounter{openaghmodulesimulation}
\newcounter{openaghmodulevimeo}
\newcounter{openaghmoduleyoutube}
\newcounter{openaghmodulevideo}
\newcounter{openaghmoduleimg}
\newcounter{openaghmoduletable}
\newcounter{openaghmodulelisting}
\newcounter{openaghmoduleequation}
% \newcounter{testcounterone}
% \newcounter{testcountertwo}

\newcommand{\resetmodulecounters}{%
	\setcounter{openaghmodulelemma}{0}
	\setcounter{openaghmoduledefinition}{0}
	\setcounter{openaghmodulelaw}{0}
	\setcounter{openaghmodulerule}{0}
	\setcounter{openaghmoduletheorem}{0}
	\setcounter{openaghmoduleexample}{0}
	\setcounter{openaghmoduleexercise}{0}
	\setcounter{openaghmodulesummary}{0}
	\setcounter{openaghmoduleconclusion}{0}
	\setcounter{openaghmoduleinformation}{0}
	\setcounter{openaghmoduleannotation}{0}
	\setcounter{openaghmoduleproperty}{0}
	\setcounter{openaghmodulealgorithm}{0}
	\setcounter{openaghmodulemodel}{0}
	\setcounter{openaghmodulesimulation}{0}
	\setcounter{openaghmodulevimeo}{0}
	\setcounter{openaghmoduleyoutube}{0}
	\setcounter{openaghmodulevideo}{0}
	\setcounter{openaghmoduleimg}{0}
	\setcounter{openaghmoduletable}{0}
	\setcounter{openaghmodulelisting}{0}
	\setcounter{openaghmoduleequation}{0}
}

% ######### COLORS #########
\definecolor{orange_bg}{RGB}{255, 251, 247}
\definecolor{blue_bg}{RGB}{247, 252, 255}
\definecolor{green_bg}{RGB}{252, 255, 244}
\definecolor{grey_bg}{RGB}{243, 243, 243}

\definecolor{orange_border}{RGB}{255, 18, 0}
\definecolor{blue_border}{RGB}{27, 78, 117}
\definecolor{green_border}{RGB}{133, 178, 0}
\definecolor{grey_border}{RGB}{109, 111, 113}

% ######### STYLE #########
% ### ORANGE ###
\mdfdefinestyle{openaghdefinition_env}
{linecolor=orange_border, frametitle=\makebox{\includesvg[]{\openaghpackagedir/icons/openagh-module-definition}}\hspace{0.3cm}{\bfseries\sffamily DEFINICJA}, topline=false, bottomline=false, rightline=false, linewidth=1pt, frametitleaboveskip=20pt, backgroundcolor=orange_bg}

\mdfdefinestyle{openaghlaw_env}
{linecolor=orange_border,frametitle=\makebox{\includesvg[]{openagh-module-law}}\hspace{0.3cm}{\bfseries\sffamily PRAWO},topline=false,bottomline=false, rightline=false, linewidth=1pt, frametitleaboveskip=20pt, backgroundcolor=orange_bg}

\mdfdefinestyle{openaghlemma_env}
{linecolor=orange_border,frametitle=\makebox{\includesvg[]{openagh-module-lemma}}\hspace{0.3cm}{\bfseries\sffamily LEMAT},topline=false,bottomline=false, rightline=false, linewidth=1pt, frametitleaboveskip=20pt, backgroundcolor=orange_bg}

\mdfdefinestyle{openaghrule_env}
{linecolor=orange_border,frametitle=\makebox{\includesvg[]{openagh-module-rule}}\hspace{0.3cm}{\bfseries\sffamily ZASADA},topline=false,bottomline=false, rightline=false, linewidth=1pt, frametitleaboveskip=20pt, backgroundcolor=orange_bg}

\mdfdefinestyle{openaghtheorem_env}
{linecolor=orange_border,frametitle=\makebox{\includesvg[]{openagh-module-theorem}}\hspace{0.3cm}{\bfseries\sffamily TWIERDZENIE},topline=false,bottomline=false, rightline=false, linewidth=1pt, frametitleaboveskip=20pt, backgroundcolor=orange_bg}

% ### BLUE ###
\mdfdefinestyle{openaghexercise_env}
{linecolor=blue_border,frametitle=\makebox{\includesvg[]{openagh-module-exercise}}\hspace{0.3cm}{\bfseries\sffamily ZADANIE},topline=false,bottomline=false, rightline=false, linewidth=1pt, frametitleaboveskip=20pt, backgroundcolor=blue_bg}

\mdfdefinestyle{openaghexample_env}
{linecolor=blue_border,frametitle=\makebox{\includesvg[]{openagh-module-example}}\hspace{0.3cm}{\bfseries\sffamily PRZYKŁAD},topline=false,bottomline=false, rightline=false, linewidth=1pt, frametitleaboveskip=20pt, backgroundcolor=blue_bg}

\mdfdefinestyle{openaghsummary_env}
{linecolor=blue_border,frametitle=\makebox{\includesvg[]{openagh-module-summary}}\hspace{0.3cm}{\bfseries\sffamily PODSUMOWANIE},topline=false,bottomline=false, rightline=false, linewidth=1pt, frametitleaboveskip=20pt, backgroundcolor=blue_bg}

% ### GREEN ###
\mdfdefinestyle{openaghalgorithm_env}
{linecolor=green_border,frametitle=\makebox{\includesvg[]{openagh-module-algorithm}}\hspace{0.3cm}{\bfseries\sffamily ALGORYTM},topline=false,bottomline=false, rightline=false, linewidth=1pt, frametitleaboveskip=20pt, backgroundcolor=green_bg}

\mdfdefinestyle{openaghconclusion_env}
{linecolor=green_border,frametitle=\makebox{\includesvg[]{openagh-module-conclusion}}\hspace{0.3cm}{\bfseries\sffamily WNIOSEK},topline=false,bottomline=false, rightline=false, linewidth=1pt, frametitleaboveskip=20pt, backgroundcolor=green_bg}

\mdfdefinestyle{openaghinformation_env}
{linecolor=green_border,frametitle=\makebox{\includegraphics[]{openagh-module-information.png}}\hspace{0.3cm}{\bfseries\sffamily INFORMACJA DODATKOWA},topline=false,bottomline=false, rightline=false, linewidth=1pt, frametitleaboveskip=20pt, backgroundcolor=green_bg}

\mdfdefinestyle{openaghannotation_env}
{linecolor=green_border,frametitle=\makebox{\includesvg[]{openagh-module-annotation}}\hspace{0.3cm}{\bfseries\sffamily UWAGA},topline=false,bottomline=false, rightline=false, linewidth=1pt, frametitleaboveskip=20pt, backgroundcolor=green_bg}

\mdfdefinestyle{openaghproperty_env}
{linecolor=green_border,frametitle=\makebox{\includesvg[]{openagh-module-property}}\hspace{0.3cm}{\bfseries\sffamily WŁASNOŚĆ},topline=false,bottomline=false, rightline=false, linewidth=1pt, frametitleaboveskip=20pt, backgroundcolor=green_bg}

% ### GREY ###
\mdfdefinestyle{openaghmodel_env}
{linecolor=grey_border,frametitle=\makebox{\includesvg[]{openagh-module-model}}\hspace{0.3cm}{\bfseries\sffamily MODEL},topline=false,bottomline=false, rightline=false, linewidth=1pt, frametitleaboveskip=20pt, backgroundcolor=grey_bg}

\mdfdefinestyle{openaghsimulation_env}
{linecolor=grey_border,frametitle=\makebox{\includesvg[]{openagh-module-simulation}}\hspace{0.3cm}{\bfseries\sffamily SYMULACJA},topline=false,bottomline=false, rightline=false, linewidth=1pt, frametitleaboveskip=20pt, backgroundcolor=grey_bg}

% ######### KOMENDY ##########
%\ScriptEnv{html}
%{\NoFonts\hfill\break}
%{\EndNoFonts}
% Old value will be stored in openaghtmpcounter
% #1 - counter that is being set
% #2 - counter that value is being assigned to counter #1
\newcommand{\copycounter}[2]{%
	\setcounter{openaghtmpcounter}{\value{#1}}
	\setcounter{#1}{\value{#2}}
	% Decrement counter becaouse figure \caption increments it behind scene
	\addtocounter{#1}{-1}
}

% Read value from openaghtmpcounter and assing it to counter #1
\newcommand{\assigntmpcounter}[1]{%
	\setcounter{#1}{\value{openaghtmpcounter}}
}

% OPENREF BACKUP DEFINITION
%\newcommand{\openref}[1]{%
%	\ifcsname r@#1\endcsname
%		\section{EXISTS}
%	\else
%		\section{NOT EXISTS}
%	\fi
%}

% Creates reference to object if it is visible inside document
%\makeatletter
%\newcommand{\openref}[3][\handbookid false]{%
%	one: #1, two: #2, three: #3,
%	\@ifundefined{r@#3}{%
%		\directlua{%
%		    	local target = "#3"
%		    	local target_split = string.split(target, ":")
%		    	local mod_id = target_split[2]
%		    	local target_obj = target_split[3]
%		    	local target_n = target_split[4]
%		    	
%		    	tex.print("\\openaghreaderroute[#1]{" .. mod_id .. "}{" .. target_n .. "}")
%		}
%	}{%
%		\ifthenelse{\equal{#2}{false}
%			{\hyperref{#3}{#2}}
%			{\autoref{#3}}
%		}
%	}%
%}
%\maekatother
%\makeatletter
%\newcommand{\openaghtestxkval}[1]{
%	\setkeys{openagh@keys}{handbookId=\handbookid,refName=false,linkLabel=false,#1}
%	
%	\openagh@refName
%	\openagh@handbookId
%	\openagh@linkLabel
%}
%\makeatother

\ifdefined\HCode
\makeatletter
\newcommand{\openaghref}[1][handbookId=\handbookid,moduleId=\modid,refName=false,linkLabel=false]{%
\setkeys{openagh@keys}{handbookId=\handbookid,moduleId=\modid,refName=false,linkLabel=false,#1}
%
% WERSJA HTML
\@ifundefined{r@\openagh@refName}{%
\directlua{%
	local target = '\openagh@refName'
	local handbook_id = '\openagh@handbookId'
	local global_mod_id = "\modid"
	local user_mod_id = "\openagh@moduleId"
	local link_label = '\openagh@linkLabel'
	local slash_sign = string.char(92)
	local hash_sign = string.char(35)
	local href_hash = slash_sign .. hash_sign
	local ignore_par = slash_sign .. "ifvmode" .. slash_sign .."IgnorePar" .. slash_sign .. "fi"
	
	local target_split = string.split(target,":")
	local mod_id = target_split[2]
	local target_obj = target_split[3]
	local target_n = target_split[4]
	local ref_caption = openagh_env_ref_caption(target_obj, target_n, link_label, true)
	
	if not (user_mod_id == global_mod_id) then
		mod_id = user_mod_id
	end
	
	local ref_url = openagh_reader_route(handbook_id, mod_id)
	tex.print(ignore_par..'\noexpand\\HCode{<a class="openagh-a" href="' .. ref_url .. '/' .. href_hash .. target ..'">' .. ref_caption .. '</a>}')
}%
}{%
\directlua{%
	local target = '\openagh@refName'
	local link_label = '\openagh@linkLabel'
	local slash_sign = string.char(92)
	local hash_sign = string.char(35)
	local href_hash = slash_sign .. hash_sign
	local ignore_par = slash_sign .. "ifvmode" .. slash_sign .."IgnorePar" .. slash_sign .. "fi"
	
	local target_split = string.split(target,":")
	local mod_id = target_split[2]
	local target_obj = target_split[3]
	local target_n = target_split[4]
	local ref_caption = openagh_env_ref_caption(target_obj, target_n, link_label, true)

	tex.sprint(ignore_par..'\noexpand\\HCode{<a href="' .. href_hash .. target .. '">' .. ref_caption .. '</a>}')
}%
}}
\makeatother
\else
\makeatletter
\newcommand{\openaghref}[1][handbookId=\handbookid,moduleId=\modid,refName=false,linkLabel=false]{%
\setkeys{openagh@keys}{handbookId=\handbookid,moduleId=\modid,refName=false,linkLabel=false,#1}
%
\@ifundefined{r@\openagh@refName}{%
\directlua{%
	local target = "\openagh@refName"
	local handbook_id = "\openagh@handbookId"
	local global_mod_id = "\modid"
	local user_mod_id = "\openagh@moduleId"
	local link_label = "\openagh@linkLabel"
	local pr_sign = string.char(37)
	local slash_sign = string.char(92)
	local hash_sign = string.char(35)
	local href_hash = slash_sign .. hash_sign
	local target_split = ""
	local mod_id = ""
	local target_obj = ""
	local target_n = ""
	local ref_caption = ""
	local reg_ex_match = string.match(target,"openaghmod:" .. pr_sign .. "d+:openagh" .. pr_sign .. "w+:" .. pr_sign .. "d+")
	
	if not (reg_ex_match == nil) then
		target_split = string.split(target,":")
		mod_id = target_split[2]
		target_obj = target_split[3]
		target_n = target_split[4]
		ref_caption = openagh_env_ref_caption(target_obj, target_n, link_label, true)
	else
		mod_id = "\modid"
		ref_caption = link_label
	end
	
	if not (user_mod_id == global_mod_id) then
		mod_id = user_mod_id
	end
	
	local ref_url = openagh_reader_route(handbook_id, mod_id)
	tex.print("\noexpand\\href{" .. ref_url .. href_hash .. target .."}" .. "{" .. ref_caption .."}")
}%
}{%
\directlua{%
	local target = "\openagh@refName"
	local handbook_id = "\openagh@handbookId"
	local global_mod_id = "\modid"
	local user_mod_id = "\openagh@moduleId"
	local link_label = "\openagh@linkLabel"
	
	local pr_sign = string.char(37)
	local target_split = ""
	local mod_id = ""
	local target_obj = ""
	local target_n = ""
	local ref_caption = ""
	local reg_ex_match = string.match(target,"openaghmod:" .. pr_sign .. "d+:openagh" .. pr_sign .. "w+:" .. pr_sign .. "d+")
	local pre_ref = "("
	local post_ref = ")"
	local ref_number_cmd = "\noexpand\\ref*{" .. target .. "}"
	
	if not (reg_ex_match == nil) then
		target_split = string.split(target,":")
		mod_id = target_split[2]
		target_obj = target_split[3]
		target_n = target_split[4]
		ref_caption = openagh_env_ref_caption(target_obj, target_n, link_label, false)
	else
		mod_id = "\modid"
		ref_caption = link_label
	end

	if not (user_mod_id == global_mod_id) then
	% -- DELETE?
		mod_id = user_mod_id
		local ref_url = openagh_reader_route(handbook_id, mod_id)
		tex.sprint("\noexpand\\href{" .. ref_url .. target .."}" .. "{" .. ref_caption .."}")
	end

	if not(ref_caption == "") then
		pre_ref = ref_caption
		post_ref = ""
	end

	if not(link_label == "false") then
	% -- Turn off evaulation of ref*{} which gets counter value assigned to given label
		ref_number_cmd = ""
	end

	tex.print("\noexpand\\hyperref[" .. target .. "]{" .. pre_ref .. ref_number_cmd .. post_ref .. "}")
	
	tex.print(is_module_private(mod_id))
}%
}}
\makeatother
\fi

% ######### FORMATOWANIE #########
% Pogrubienie \textbf{}

% KURSYWA* \textit{}

% PRZEKREŚLENIE* \usepackage{normalem}{uelm}; \sout{}

% PODKREŚLENIE* \underline{}

% Nagłówek H1 - H3 \chapter{} \section{} \subsection
% nagłówki nienumerowalne

% \h1
\ifdefined\HCode
% \newcommand{\hone}[1]{\ifvmode\IgnorePar\fi\EndP\HCode{<h1 class="openagh-header1">#1</h1>}\par}
\newcommand{\hone}[1]{%
\ifvmode\IgnorePar\fi\EndP\HCode{<h1 class="openagh-header1">}
#1
\ifvmode\IgnorePar\fi\EndP\HCode{</h1>}
% \par
}
\else
\newcommand{\hone}[1]{\vspace{5mm}\textbf{\LARGE #1}\newline\vspace{5mm}}
\fi

% \h2
\ifdefined\HCode
% \newcommand{\htwo}[1]{\ifvmode\IgnorePar\fi\EndP\HCode{<h2 class="openagh-header2">#1</h2>}\par}
\newcommand{\htwo}[1]{%
\ifvmode\IgnorePar\fi\EndP\HCode{<h2 class="openagh-header2">}
#1
\ifvmode\IgnorePar\fi\EndP\HCode{</h2>}
% \par
}
\else
\newcommand{\htwo}[1]{\vspace{5mm}\textbf{\Large #1}\newline\vspace{5mm}}
\fi

% \h3
\ifdefined\HCode
% \newcommand{\hthree}[1]{\ifvmode\IgnorePar\fi\EndP\HCode{<h3 class="openagh-header3">#1</h3>}\par}
\newcommand{\hthree}[1]{%
\ifvmode\IgnorePar\fi\EndP\HCode{<h3 class="openagh-header3">}
#1
\ifvmode\IgnorePar\fi\EndP\HCode{</h3>}
% \par
}
\else
\newcommand{\hthree}[1]{\vspace{5mm}\textbf{\large #1}\newline\vspace{5mm}}
\fi

% \h4
\ifdefined\HCode
% \newcommand{\hfour}[1]{\ifvmode\IgnorePar\fi\EndP\HCode{<h4 class="openagh-header4">#1</h4>}\par}
\newcommand{\hfour}[1]{%
\ifvmode\IgnorePar\fi\EndP\HCode{<h4 class="openagh-header4">}
#1
\ifvmode\IgnorePar\fi\EndP\HCode{</h4>}
% \par
}
\else
\newcommand{\hfour}[1]{\vspace{5mm}\textbf{\normalsize #1}\newline\vspace{5mm}}
\fi

% \h5
\ifdefined\HCode
% \newcommand{\hfive}[1]{\ifvmode\IgnorePar\fi\EndP\HCode{<h5 class="openagh-header5">#1</h5>}\par}
\newcommand{\hfive}[1]{%
\ifvmode\IgnorePar\fi\EndP\HCode{<h5 class="openagh-header5">}
#1
\ifvmode\IgnorePar\fi\EndP\HCode{</h5>}
% \par
}
\else
\newcommand{\hfive}[1]{\vspace{5mm}\textbf{\small #1}\newline\vspace{5mm}}
\fi

% \h6
\ifdefined\HCode
% \newcommand{\hsix}[1]{\ifvmode\IgnorePar\fi\EndP\HCode{<h6 class="openagh-header6">#1</h6>}\par}
\newcommand{\hsix}[1]{%
\ifvmode\IgnorePar\fi\EndP\HCode{<h6 class="openagh-header6">}
#1
\ifvmode\IgnorePar\fi\EndP\HCode{</h6>}
% \par
}
\else
\newcommand{\hsix}[1]{\vspace{5mm}\textbf{\footnotesize #1}\newline\vspace{5mm}}
\fi

% nagłówki numerowalne
% \chapter
% \section
% \subsection

% Wyśrodkuj \begin{center} \end{center}

% Lista numerowana \begin{enumerate} \item... \item... \end{enumerate} - style numerowania? style zagnieżdżonych list

% Lista wypunktowana \begin{itemize} \item... \item... \end{itemize}

% Wiki Link - odnośnik do wzoru, modułu ?? - odnośnik w module \openaghref{label_name}

%\makeatletter
%\newenvironment{link}[1]
%{
%  \@ifundefined{\csname r@#1\endcsname}
%	{\href{https://google.pl}{Tutaj} jest przedstawiona definicja całki LINK}
%	{\hyperlink{def:calka}{Tutaj} jest przedstawiona definicja całki}
%}
%\makeatother
%
%\makeatletter
%\newenvironment{link_hyper}[1]
%{
%  \@ifundefined{@#1}
%	{\href{https://google.pl}{Tutaj} jest przedstawiona definicja całki LINK}
%	{\hyperlink{def:calka}{Tutaj} jest przedstawiona definicja całki}
%}
%\makeatother

%\newenvironment{target}[2]
%{
%  \hypertarget{#1}{#2}
%}

%\makeatletter
%\newenvironment{refff}[1]
%{
%  \@ifundefined{\csname r@#1\endcsname}
%	{\href{https://google.pl}{Tutaj} jest przedstawiona definicja całki LINK}
%	{\ref{def:calka} jest przedstawiona definicja całki}
%}
%\makeatother
%
% Tabela \begin{tabular} \end{tabular} - \usepackage{array} dla zdefiniowanych szerokości komórek
%\newenvironment{openaghtable}[2][openaghmod:\modid:openaghtable:\theopenaghtable]
% Argumenty:
% 	label - kotwica
% 	caption - podpis tabeli
%

\makeatletter
\ifdefined\HCode
\newenvironment{openaghequation}
{%
	\refstepcounter{openaghmoduleequation}
	\setkeys{openagh@keys}{label=openaghmod:\modid:openaghequation:\theopenaghmoduleequation}
	\openaghlabelenvs{\openagh@label}
	\equation % command for \begin{equation} - with environment evaulation (begin{} \end{}) HTML is generated wrong
}
{%
	\endequation
}
% \NewEnviron{openaghequation}
% {%
% 	\refstepcounter{openaghmoduleequation}
% 	\setkeys{openagh@keys}{label=openaghmod:\modid:openaghequation:\theopenaghmoduleequation}
% 	\openaghlabelenvs{\openagh@label} % TEST!!
% 	\begin{equation}
% 		\environbody
% 	\end{equation}
% }
\else
% \NewEnviron{openaghequation}
% {%
% 	\refstepcounter{openaghmoduleequation}
% 	\setkeys{openagh@keys}{label=openaghmod:\modid:openaghequation:\theopenaghmoduleequation}
% 	\openaghlabelenvs{\openagh@label} % TEST!!
% 	\begin{equation}
% 		\BODY
% 	\end{equation}
% }
\newenvironment{openaghequation}
{%
	\refstepcounter{openaghmoduleequation}
	\setkeys{openagh@keys}{label=openaghmod:\modid:openaghequation:\theopenaghmoduleequation}
	\begin{equation}
	\openaghlabelenvs{\openagh@label}
}
{%
	\end{equation}
}
\fi
\makeatother

\makeatletter 	
\newenvironment{openaghtable}[1][caption={Opis tabeli}]
{%
	\refstepcounter{openaghmoduletable}
	\refstepcounter{openaghtable}
	\setkeys{openagh@keys}{label=openaghmod:\modid:openaghtable:\theopenaghmoduletable,caption={Opis tabeli},#1}
%    \label{\openagh@label}
	\openaghlabelenvs{\openagh@label}
	\begin{table}[h]
		\copycounter{table}{openaghtable}
		\caption{\openagh@caption}
		\assigntmpcounter{table}
		\begin{center}
}
{%
	\end{center} 
	\end{table}
}
\makeatother

% Kotwica - dodanie w dowolnym miejscu unikalnej nazwy po której można linkować
\ifdefined\HCode
\newcommand{\openaghlabel}[1]
{%
	\phantomsection
	\label{#1}
	\HCode{%
		<a class="openagh-label" name="#1"></a>
	}
}
\else
\newcommand{\openaghlabel}[1]
{%
	\phantomsection
	\label{#1}
}
\fi

% Kotwica w otoczeniach OPENAGH
\ifdefined\HCode
\newcommand{\openaghlabelenvs}[1]
{%
	\phantomsection
	\label{#1}
	\HCode{%
	<a class="openagh-label" name="#1"></a>
	}
}
\else
\newcommand{\openaghlabelenvs}[1]
{%
	\label{#1}
}
\fi

% ######### MULTIMEDIA #########
% Tabela z obrazka
% argumenty:
%	#1 - opcjonalna kotwica
%	#2 - plik
%	#3 - podpis
%	#4 - tekst alternatywny
%	#5 - szerokość (w px)
%	#6 - wysokość (w px)
%	#7 - wyrównanie na ekranie
\makeatletter
\ifdefined\HCode
\newcommand{\openaghimgtable}[1][file={},caption={Opis tabeli},width={},height={},align=center,alt={Tekst alternatywny}]
{%
	\refstepcounter{openaghmoduletable}
	\refstepcounter{openaghtable}
	\setkeys{openagh@keys}{label=openaghmod:\modid:openaghtable:\theopenaghmoduletable,file={},caption={Opis tabeli},width={},height={},align=center,alt={Tekst alternatywny},#1}
	\openaghlabelenvs{\openagh@label}
	\HCode{%
		<figure>
			<img
			src="\openagh@file"
			title="\openagh@caption"
			alt="\openagh@alt"
			width="\openagh@width"
			height="\openagh@height"
			/>
			<figcaption> \tablename \theopenaghtable: \openagh@caption </figcaption>
		</figure>
	}
}
\else
\newcommand{\openaghimgtable}[1][file={},caption={Opis tabeli},width={},height={},align=center,alt={Tekst alternatywny}]
{%
	\refstepcounter{openaghmoduletable}
	\refstepcounter{openaghtable}
	\setkeys{openagh@keys}{label=openaghmod:\modid:openaghtable:\theopenaghmoduletable,file={},caption={Opis tabeli},width={},height={},align=center,alt={Tekst alternatywny},#1}
	\renewcommand{\figurename}{Tabela}
	\openaghlabelenvs{\openagh@label}
	\begin{figure}[H]
		% Save original value of counter to tmpcounter and change figure counter
		\copycounter{figure}{openaghtable}
		\caption{\openagh@caption}
		% Restore figure counter to original value
		\assigntmpcounter{figure}
		\directlua{%
			local position = "\openagh@align"
			local width = "\openagh@width"
			local height = "\openagh@height"
			local file = "\openagh@file"
			local cmd = openagh_include_image(position, width, height, file)

			tex.print(cmd)
		}
	\end{figure}
	\renewcommand{\figurename}{Rysunek}
}
\fi
\makeatother


% Obrazek
% argumenty:
%	#1 - opcjonalna kotwica
%	#2 - plik
%	#3 - podpis
%	#4 - tekst alternatywny
%	#5 - szerokość (w px)
%	#6 - wysokość (w px)
%	#7 - wyrównanie na ekranie
\makeatletter
\ifdefined\HCode
\newcommand{\openaghimg}[1][file={},caption={Podpis obrazka},width={},height={},align=center,alt={Tekst alternatywny}]
{%
	\refstepcounter{openaghimg}
	\refstepcounter{openaghmoduleimg}
	\setkeys{openagh@keys}{label=openaghmod:\modid:openaghimg:\theopenaghmoduleimg,file={},caption={Podpis obrazka},width={},height={},align=center,alt={Tekst alternatywny},#1}
	\openaghlabelenvs{\openagh@label}
 	\HCode{
		<figure>
			<img
			src="\openagh@file"
			title="\openagh@caption"
			alt="\openagh@alt"
			width="\openagh@width"
			height="\openagh@height"
			/>
			<figcaption> \figurename \thickspace \theopenaghimg: \openagh@caption </figcaption>
		</figure>
	}
}
\else
\newcommand{\openaghimg}[1][file={},caption={Podpis obrazka},width={},height={},align=center,alt={Tekst alternatywny}]
{%
	\refstepcounter{openaghmoduleimg}
	\refstepcounter{openaghimg}
	\setkeys{openagh@keys}{label=openaghmod:\modid:openaghimg:\theopenaghmoduleimg,file={},caption={Podpis obrazka},width={},height={},align=center,alt={Tekst alternatywny},#1}
	\openaghlabelenvs{\openagh@label}
	\begin{figure}[H]
		\directlua{%
		    local position = "\openagh@align"
		    local width = "\openagh@width"
		    local height = "\openagh@height"
		    local file = "\openagh@file"
			local cmd = openagh_include_image(position, width, height, file)

			tex.print(cmd)
		}
		\copycounter{figure}{openaghimg}
		\caption{\openagh@caption}
		\assigntmpcounter{figure}
	\end{figure}
}
\fi
\makeatother

% Vimeo, Yotube, Player
% argumenty:
% #1 - link
%	#2 - tytuł filmu (tekst zastępczy)
%	#3 - obrazek zastępczy
%	#4 - szerokość (HTML)
%	#5 - wysokość (HTML)
%	#6 - jakość (HTML) (NIE WIEM CO Z TYM ZROBIC) ?? Po CO ??
% #7 - zezwól na pełny ekran(tak - allowfullscreen nie - '') (HTML YT/VIMEO) ?? PO CO ??

\makeatletter
\ifdefined\HCode
\newcommand{\openaghvimeo}[1][title={Tytuł filmu},link={},altImg={},width={},height={}]
{%
	\refstepcounter{openaghmodulevimeo}
	\refstepcounter{openaghvimeo}
	\setkeys{openagh@keys}{title={Tytuł filmu},label=openaghmod:\modid:openaghvimeo:\theopenaghmodulevimeo,link={},altImg={},width={},height={},#1}
	\openaghlabelenvs{\openagh@label}
    
	%\notblank{#4}{\includegraphics[]{#4}}{}
	\HCode{<iframe id="\openagh@label-object"
		class="openaghvimeo openaghiframe openaghvideo"
		title="\openagh@title"
		width="\openagh@width"
		height="\openagh@height" src="\openagh@link"
		allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; autoplay; fullscreen"
		frameborder="0" allowfullscreen></iframe>}
	%\ifthenelse{\equal{#8}{false}
  %  {\HCode{<iframe id="#1-object"
  %  		title="#3"
  %  		width="#5"
  %  		frameborder="0" allow="autoplay; fullscreen; picture-in-picture"
  %  		height="#6" src="#2"></iframe>}
  %  	}
  %  	{\HCode{<iframe id="#1-object"
  %  		title="#3"
  %  		width="#5"
  %  		frameborder="0" allow="autoplay; fullscreen; picture-in-picture"
  %  		height="#6" src="#2" allowfullscreen></iframe>}
  %  	}
  %  }
}

\newcommand{\openaghyoutube}[1][title={Tytuł filmu},link={},altImg={},width={},height={}]
{%
	\refstepcounter{openaghmoduleyoutube}
	\refstepcounter{openaghyoutube}
	\setkeys{openagh@keys}{title={Tytuł filmu},label=openaghmod:\modid:openaghyoutube:\theopenaghmoduleyoutube,link={},altImg={},width={},height={},#1}
	\openaghlabelenvs{\openagh@label}
	
	%\notblank{#4}{\includegraphics[]{#4}}{}
	\HCode{<iframe id="\openagh@label-object"
		class="openaghyoutbe openaghiframe openaghvideo"
		title="\openagh@title"
		width="\openagh@width"
		height="\openagh@height" src="\openagh@link"
		allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; autoplay; fullscreen"
		frameborder="0" allowfullscreen></iframe>}
}

\newcommand{\openaghvideo}[1][title={Tytuł filmu},file={},altImg={},width={},height={}]
{%
	\refstepcounter{openaghmodulevideo}
	\refstepcounter{openaghvideo}
	\setkeys{openagh@keys}{title={Tytuł filmu},label=openaghmod:\modid:openaghvideo:\theopenaghmodulevideo,file={},altImg={},width={},height={},#1}
	\openaghlabelenvs{\openagh@label}
	\HCode{%
		<video title="\openagh@title" width="\openagh@width" height="\openagh@height" controls>
			<source src="\openagh@file" type="video/mp4">
		</video>}
}
\else
\newcommand{\openaghvimeo}[1][title={Tytuł filmu},link={},altImg={},width={},height={}]
{%
	\refstepcounter{openaghmodulevimeo}
	\refstepcounter{openaghvimeo}
	\setkeys{openagh@keys}{title={Tytuł filmu},label=openaghmod:\modid:openaghvimeo:\theopenaghmodulevimeo,link={},altImg={},width={},height={},#1}
	\openaghlabelenvs{\openagh@label}
  \notblank{\openagh@altImg}{\includegraphics[center]{\openagh@altImg}}{}
    
	\begin{figure}[H]
		\centering
		\qrcode[height=1in]{\openagh@link}
		\begin{center}
				\url{\openagh@link}
				\\
				\openagh@title
		\end{center}
	\end{figure}
}

\newcommand{\openaghyoutube}[1][title={Tytuł filmu},link={},altImg={},width={},height={}]
{%
	\refstepcounter{openaghmoduleyoutube}
	\refstepcounter{openaghyoutube}
	\setkeys{openagh@keys}{title={Tytuł filmu},label=openaghmod:\modid:openaghyoutube:\theopenaghmoduleyoutube,link={},altImg={},width={},height={},#1}
	\openaghlabelenvs{\openagh@label}
	%\notblank{\openagh@altImage}{\includegraphics[width=\openagh@width,height=\openagh@height, center]{\openagh@altImage}}{}
	\notblank{\openagh@altImg}{\includegraphics[center]{\openagh@altImg}}{}
	\begin{figure}[H]
		\centering
		\qrcode[height=1in]{\openagh@link}
		\begin{center}
				\url{\openagh@link}
				\\
				\openagh@title
		\end{center}
	\end{figure}
}

\newcommand{\openaghvideo}[1][title={Tytuł filmu},file={},altImg={},width={},height={}]
{%
	\refstepcounter{openaghmodulevideo}
	\refstepcounter{openaghvideo}
	\setkeys{openagh@keys}{title={Tytuł filmu},label=openaghmod:\modid:openaghvideo:\theopenaghmodulevideo,file={},altImg={},width={},height={},#1}
%	\label{#1}
	\openaghlabelenvs{\openagh@label}
% 	\notblank{\openagh@altImage}{\includegraphics[width=\openagh@width,height=\openagh@height, center]{\openagh@altImage}}{}
	\notblank{\openagh@altImg}{\includegraphics[center]{\openagh@altImg}}{}
	\begin{figure}[H]
		\centering
		\qrcode[height=1in]{\openagh@file}
		\begin{center}
			\href{\openagh@file}
			\\
			\openagh@title
		\end{center}
	\end{figure}
}
\fi
\makeatother


% Animacja - błąd gramatyki przy wrzucaniu do edytora, nie mogę znleźć tego otoczenia w innych podręcznikach
%
% \newenvironment{openaghanimation}[1]
% {
%   \refstepcounter{openaghanimation}
%   \subsection{ \textbf{Symulacja \theopenaghanimation: #1} }
% }
% {}

% Symulacja
% Argumenty:
% #1 - Alternatywna kotwica
% #2 - Tytuł
% #3 - Plik
% #4 - Format
% #5 - Tekst alternatywny
% #6 - Tytuł obrazka zastępczego
% #7 - Tekst alternatywny obrazka zastępczego 
% #8 - Podpis obrazka
% #9 - Plik obrazka

\makeatletter
\ifdefined\HCode
\newenvironment{openaghsimulation}[1][title={},file={},iframeLink={},linkLabel={Plik do pobrania},altImg={},altImgText={}]
{%
	\refstepcounter{openaghmodulesimulation}
	\refstepcounter{openaghsimulation}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghsimulation:\theopenaghmodulesimulation,file={},iframeLink={},linkLabel={Plik do pobrania},altImg={},altImgText={},#1}
	\openaghlabelenvs{\openagh@label}
  %\label{#1}
  %\subsection{ \textbf{Symulacja \theopenaghsimulation: #2} }
	% \subsection{ \textbf{\openaghsimulationecap \thickspace \theopenaghsimulation: \openagh@title} }
	\hthree{\openaghsimulationecap \theopenaghsimulation: \openagh@title}
	% \\
  %\ifthenelse{\equal{\openagh@iframeLink}{}
	%{}
	%{\HCode{%
	%<iframe id="\openagh@label-object"
  %  title="\openagh@title"
  %  src="\openagh@linkLabel"
  %  allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; autoplay; fullscreen"
  %  frameborder="0"
  %>
  %</iframe>
	%}}
	\notblank{\openagh@iframeLink}{\HCode{%
	<iframe id="\openagh@label-object"
	 class="openaghiframe openaghsimulation__iframe"
	 title="\openagh@title"
	 src="\openagh@linkLabel"
	 allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; autoplay; fullscreen"
	 frameborder="0"
	>
  	</iframe>
	}}{\notblank{\openagh@altImg}{\HCode{%
	<img class="openaghaltimage openaghsimulation__alt-img src="\openagh@altImg" alt="\openagh@altImgText"/>
	}{}}}
	\\
	\notblank{\openagh@file}{\href{\openagh@file}{\openagh@linkLabel}}{}
%	\iftheneelse{\equal{\openagh@file}{}}
%	{}
%	{\href{\openagh@file}{\openagh@linkLabel}}
  %\directlua{%
  	%local file = "\openagh@file"
  	%local file = "openagh-media_view.php?fileId=1103&type=simulation"
  	%local file_ split= string.split(file, "?")
  	%tex.print(file_split)
  	%\HCode{}
  %}
  %\HCode{}
}
{}
\else
\newenvironment{openaghsimulation}[1][title={},file={},iframeLink={},linkLabel={Plik do pobrania}]
{%
	\refstepcounter{openaghmodulesimulation}
	\refstepcounter{openaghsimulation}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghsimulation:\theopenaghmodulesimulation,file={},iframeLink={},linkLabel={Plik do pobrania},altImg={},altImgText={},#1}
	\openaghlabelenvs{\openagh@label}
	%\label{#1}
	%\subsection{ \textbf{Symulacja \theopenaghsimulation: #2} }
	% \subsection{ \textbf{\openaghsimulationcap \thickspace \theopenaghsimulation: \openagh@title} }
	\hthree{ \openaghsimulationcap \thickspace \theopenaghsimulation: \openagh@title }
	\\
	%\ifthenelse{\equal{\openagh@file}{}}{}
	%{\href{\openagh@file}{\openagh@linkLabel}}
	\notblank{\openagh@altImg}{\includegraphics[center]{\openagh@altImg}}{}
	\notblank{\openagh@file}{\href{\openagh@file}{\openagh@linkLabel}}{}
}
{}
\fi
\surroundwithmdframed[style=openaghsimulation_env]{openaghsimulation}
\makeatother

\newenvironment{openaghwrapper}{}{}

\newenvironment{openaghsimdescription}{}{}

\newcommand{\openaghsimauthors}[1]
{%
	\begin{openaghwrapper}
		%\ifthenelse{\equal{#1}{false}
		%{\openaghauthorcap: {#2}}
		\openaghauthorcap: #1
	\end{openaghwrapper}
}

\newcommand{\openaghsimlicence}[1]
{%
	\begin{openaghwrapper}
		%\ifthenelse{\equal{#1}{false}
		%{\openaghlicencecap: {#2}}
		%{Licencja: \href{#1}{#2}}}
		\openaghlicencecap: #1
	\end{openaghwrapper}
}

% Wzór z obrazka
\makeatletter
\ifdefined\HCode
\newcommand{\openaghimgformula}[1][title={Tytuł wzoru z obrazka},file={},width={},height={},align=center,alt={Tekst alternatywny}]
{%
	\refstepcounter{openaghmoduleequation}
	\refstepcounter{equation}
	\setkeys{openagh@keys}{title={Tytuł wzoru z obrazka},label=openaghmod:\modid:openaghformula:\theequation,file={},width={},height={},align=center,alt={Tekst alternatywny},#1}
	\openaghlabelenvs{\openagh@label}
	\HCode{
		<figure class="openaghfigure openaghimgformula">
			<img
			class="openaghimgformula__image"
			src="\openagh@file"
			title="\openagh@title"
			alt="\openagh@alt"
			width="\openagh@width"
			height="\openagh@height"
			/>
			<figcaption class="openaghimgformula__equation-counter"> (\theequation) </figcaption>
		</figure>
  }
}
\else
\newcommand{\openaghimgformula}[1][title={Tytuł wzoru z obrazka},file={},width={},height={},align=center,alt={Tekst alternatywny}]
{%
	\refstepcounter{openaghmoduleequation}
	\refstepcounter{equation}
	\setkeys{openagh@keys}{title={Tytuł wzoru z obrazka},label=openaghmod:\modid:openaghformula:\theopenaghmoduleformula,file={},width={},height={},align=center,alt={Tekst alternatywny},#1}
	\openaghlabelenvs{\openagh@label}
	\begin{figure}[H]
		\directlua{%
			local position = "\openagh@align"
			local width = "\openagh@width"
			local height = "\openagh@height"
			local file = "\openagh@file"

			local cmd = openagh_include_image(position, width, height, file)

			tex.print(cmd)
		}
		\theequation
	\end{figure}
	%\renewcommand{\figurename}{Rysunek}
}
\fi
\makeatother


% Wzór chemiczny 3D - wstawiany jako OBRAZ - nie ma

% Kod źródłowy
% Obudować swoim otoczeniem
% podpis, plik, kotwica, tekst alternatywny
% \makeatletter
% \newenvironment{openaghlisting}[1][caption={Podpis kodu},file={},alt={Tekst alternatywny}]
% {%
% 	\refstepcounter{openaghlisting}
% 	\setkeys{openagh@keys}{caption={Podpis kodu},label=openaghmod:\modid:openaghlisting:\theopenaghlisting,file={},alt={Tekst alternatywny},#1}
% 	\renewcommand{\lstlistingname}{\openaghlistingcap}
% 	\openaghlabelenvs{\openagh@label}
% 	%\begin{figure}[H]
% 		% Save original value of counter to tmpcounter and change figure counter
% 	\copycounter{lstlisting}{openaghlisting}
% 	\lstinputlisting[language=Octave,caption=\openagh@caption]{\openagh@file}
% %		\caption{\openagh@caption}
% 		% Restore figure counter to original value
% 	\assigntmpcounter{lstlisting}
% 	\renewcommand{\lstlistingname}{Listing}
% }
% \makeatother

\makeatletter
\ifdefined\HCode
\newcommand{\openaghlisting}[1][caption={Podpis kodu},file={},alt={Tekst alternatywny}]
{%
	\refstepcounter{openaghmodulelisting}
	\refstepcounter{openaghlisting}
	\setkeys{openagh@keys}{caption={Podpis kodu},label=openaghmod:\modid:openaghlisting:\theopenaghmodulelisting,file={},alt={Tekst alternatywny},#1}
	\renewcommand{\lstlistingname}{\openaghlistingcap}
	\openaghlabelenvs{\openagh@label}
	%\begin{figure}[H]
		% Save original value of counter to tmpcounter and change figure counter
	\copycounter{lstlisting}{openaghlisting}
	\lstinputlisting[caption=\openagh@caption]{\openagh@file}
%		\caption{\openagh@caption}
		% Restore figure counter to original value
	\assigntmpcounter{lstlisting}
	\renewcommand{\lstlistingname}{Listing}
}
\else
\newcommand{\openaghlisting}[1][caption={Podpis kodu},file={},alt={Tekst alternatywny}]
{%
	\refstepcounter{openaghlisting}
	\refstepcounter{openaghmodulelisting}
	\setkeys{openagh@keys}{caption={Podpis kodu},label=openaghmod:\modid:openaghlisting:\theopenaghmodulelisting,file={},alt={Tekst alternatywny},#1}
	\renewcommand{\lstlistingname}{\openaghlistingcap}
	\openaghlabelenvs{\openagh@label}
	%\begin{figure}[H]
		% Save original value of counter to tmpcounter and change figure counter
	\copycounter{lstlisting}{openaghlisting}
	\lstinputlisting[language=Octave,caption=\openagh@caption]{\openagh@file}
%		\caption{\openagh@caption}
		% Restore figure counter to original value
	\assigntmpcounter{lstlisting}
	\renewcommand{\lstlistingname}{Listing}
}
\fi
\makeatother

% ######### OTOCZENIA #########
% Lemat
\makeatletter
\ifdefined\HCode
\newenvironment{openaghlemma}[1][title={}]
{%
	\refstepcounter{openaghmodulelemma}
	\refstepcounter{openaghlemma}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghlemma:\theopenaghmodulelemma,#1}
	\openaghlabelenvs{\openagh@label}
	%\label{#1}
	%\textbf{Definicja \theopenaghdefinition: #2}
	  % \subsection{ \textbf{\openaghdefinitioncap \thickspace \theopenaghdefinition : \openagh@title } }
%  \label{#1}
%  \textbf{Lemat \theopenaghlemma: #2}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{<div class="openaghlemma-name">}
	% \subsection{ \textbf{\openaghlemmacap \thickspace \theopenaghlemma: \openagh@title} }
	\hthree{\openaghlemmacap \thickspace \theopenaghlemma: \openagh@title}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{</div><br />}
	\HCode{<div class="openaghlemma-data">}
}
{\ifvmode\IgnorePar\fi\EndP\HCode{</div>}}
\else
\newenvironment{openaghlemma}[1][title={}]
{%
	\refstepcounter{openaghmodulelemma}
	\refstepcounter{openaghlemma}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghlemma:\theopenaghmodulelemma,#1}
	\openaghlabelenvs{\openagh@label}
	%  \label{#1}
	%  \textbf{Lemat \theopenaghlemma: #2}
	% \subsection{ \textbf{\openaghlemmacap \thickspace \theopenaghlemma: \openagh@title} }
	\hthree{\openaghlemmacap \thickspace \theopenaghlemma: \openagh@title}
	\\
}
{}
\surroundwithmdframed[style=openaghlemma_env]{openaghlemma}
\fi
\makeatother

% Definicja
\makeatletter
\ifdefined\HCode
\newenvironment{openaghdefinition}[1][title={}]
{%
	\refstepcounter{openaghmoduledefinition}
	\refstepcounter{openaghdefinition}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghdefinition:\theopenaghmoduledefinition,#1}
	\openaghlabelenvs{\openagh@label}
  %\label{#1}
  %\textbf{Definicja \theopenaghdefinition: #2}
  	\ifvmode\IgnorePar\fi\EndP
	\HCode{<div class="openaghdefinition-name">}
	\hthree{ \openaghdefinitioncap \thickspace \theopenaghdefinition: \openagh@title }
	\ifvmode\IgnorePar\fi\EndP
	\HCode{</div><br />}
	\HCode{<div class="openaghdefinition-data">}
}
{\ifvmode\IgnorePar\fi\EndP\HCode{</div>}}
\else
\newenvironment{openaghdefinition}[1][title={}]
{%
	\refstepcounter{openaghmoduledefinition}
	\refstepcounter{openaghdefinition}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghdefinition:\theopenaghmoduledefinition,#1}
	\openaghlabelenvs{\openagh@label}
  %\label{#1}
  %\textbf{Definicja \theopenaghdefinition: #2}
	% \subsection{ \textbf{\openaghdefinitioncap \thickspace \theopenaghdefinition: \openagh@title} }
	\hthree{\openaghdefinitioncap \thickspace \theopenaghdefinition : \openagh@title }
	\\
}
{}
\surroundwithmdframed[style=openaghdefinition_env]{openaghdefinition}
\fi
\makeatother

% Prawo
\makeatletter
\ifdefined\HCode
\newenvironment{openaghlaw}[1][title={}]
{%
	\refstepcounter{openaghmodulelaw}
	\refstepcounter{openaghlaw}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghlaw:\theopenaghmodulelaw,#1}
	\openaghlabelenvs{\openagh@label}
	%\label{#1}
	%\subsection{ \textbf{Prawo \theopenaghlaw: #2} }
	\ifvmode\IgnorePar\fi\EndP
	\HCode{<div class="openaghlaw-name">}
	\hthree{\openaghlawcap \thickspace \theopenaghlaw: \openagh@title}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{</div><br />}
	\HCode{<div class="openaghlaw-data">}
}
{\ifvmode\IgnorePar\fi\EndP\HCode{</div>}}
\else
\newenvironment{openaghlaw}[1][title={}]
{%
	\refstepcounter{openaghmodulelaw}
	\refstepcounter{openaghlaw}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghlaw:\theopenaghmodulelaw,#1}
	\openaghlabelenvs{\openagh@label}
	%\label{#1}
	%\subsection{ \textbf{Prawo \theopenaghlaw: #2} }
	% \subsection{ \textbf{\openaghlawcap \thickspace \theopenaghlaw: \openagh@title} }
	\hthree{\openaghlawcap \thickspace \theopenaghlaw: \openagh@title}
	\\
}
{}
\surroundwithmdframed[style=openaghlaw_env]{openaghlaw}
\fi
\makeatother

% Zasada
\makeatletter
\ifdefined\HCode
\newenvironment{openaghrule}[1][title={}]
{%
	\refstepcounter{openaghmodulerule}
	\refstepcounter{openaghrule}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghrule:\theopenaghmodulerule,#1}
	\openaghlabelenvs{\openagh@label}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{<div class="openaghrule-name">}
	\hthree{\openaghrulecap \thickspace \theopenaghrule: \openagh@title}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{</div><br />}
	\HCode{<div class="openaghrule-data">}
}
{\ifvmode\IgnorePar\fi\EndP\HCode{</div>}}
\else
\newenvironment{openaghrule}[1][title={}]
{%
	\refstepcounter{openaghmodulerule}
	\refstepcounter{openaghrule}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghrule:\theopenaghmodulerule,#1}
	\openaghlabelenvs{\openagh@label}
	%\label{#1}
	%\subsection{ \textbf{Zasada \theopenaghrule: #2} }
	% \subsection{ \textbf{\openaghrulecap \thickspace \theopenaghrule: \openagh@title} }
	\hthree{\openaghrulecap \thickspace \theopenaghrule: \openagh@title}
	\\
}
{}
\surroundwithmdframed[style=openaghrule_env]{openaghrule}
\fi
\makeatother

% Twierdzenie
\makeatletter
\ifdefined\HCode
\newenvironment{openaghtheorem}[1][title={}]
{%
	\refstepcounter{openaghmoduletheorem}
	\refstepcounter{openaghtheorem}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghtheorem:\theopenaghmoduletheorem,#1}
	\openaghlabelenvs{\openagh@label}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{<div class="openaghtheorem-name">}
	\hthree{\openaghtheoremcap \thickspace \theopenaghtheorem: \openagh@title}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{</div><br />}
	\HCode{<div class="openaghtheorem-data">}
}
{\ifvmode\IgnorePar\fi\EndP\HCode{</div>}}
\else
\newenvironment{openaghtheorem}[1][title={}]
{%
	\refstepcounter{openaghmoduletheorem}
	\refstepcounter{openaghtheorem}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghtheorem:\theopenaghmoduletheorem,#1}
	\openaghlabelenvs{\openagh@label}
	%\label{#1}
	%\subsection{ \textbf{Twierdzenie \theopenaghtheorem: #2} }
	% \subsection{ \textbf{\openaghtheoremcap \thickspace \theopenaghtheorem: \openagh@title} }
	\hthree{\openaghtheoremcap \thickspace \theopenaghtheorem: \openagh@title}
	\\
}
{}
\surroundwithmdframed[style=openaghtheorem_env]{openaghtheorem}
\fi
\makeatother

% Założenia
\newenvironment{openaghassumptions}
{%
  \hsix{\openaghassumptionscap:}
}
{}

% Teza
\newenvironment{openaghthesis}
{%
  \hsix{\openaghthesiscap:}
}
{}

%Wyprowadzenie - nie ma styli w starym serwisie
%
\makeatletter
\ifdefined\HCode
\newenvironment{openaghderivation}[1][title={}]
{%
	\refstepcounter{openaghmodulederivation}
	\refstepcounter{openaghderivation}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghderivation:\theopenaghmodulederivation,#1}
	\openaghlabelenvs{\openagh@label}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{<div class="openaghderivation-name">}
	\hthree{\openaghderivationcap \thickspace \theopenaghderivation: \openagh@title}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{</div><br />}
	\HCode{<div class="openaghderivation-data">}
}
{\ifvmode\IgnorePar\fi\EndP\HCode{</div>}}
\else
\newenvironment{openaghderivation}[1][title={}]
{%
	\refstepcounter{openaghmodulederivation}
	\refstepcounter{openaghderivation}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghderivation:\theopenaghmodulederivation,#1}
	\openaghlabelenvs{\openagh@label}
   %\label{#1}
   %\subsection{ \textbf{Wyprowadzenie \theopenaghderivation: #2} }
	% \subsection{ \textbf{\openaghderivationcap \thickspace \theopenaghderivation: \openagh@title} }
	\hthree{\openaghderivationcap \thickspace \theopenaghderivation: \openagh@title}
	\\
}
{}
\fi
\makeatother

% Przykład
\makeatletter
\ifdefined\HCode
\newenvironment{openaghexample}[1][title={}]
{%
	\refstepcounter{openaghmoduleexample}
	\refstepcounter{openaghexample}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghexample:\theopenaghmoduleexample,#1}
	\openaghlabelenvs{\openagh@label}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{<div class="openaghexample-name">}
	\hthree{\openaghexamplecap \thickspace \theopenaghexample: \openagh@title}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{</div><br />}
	\HCode{<div class="openaghexample-data">}
}
{\ifvmode\IgnorePar\fi\EndP\HCode{</div>}}
\else
\newenvironment{openaghexample}[1][title={}]
{%
	\refstepcounter{openaghmoduleexample}
	\refstepcounter{openaghexample}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghexample:\theopenaghmoduleexample,#1}
	\openaghlabelenvs{\openagh@label}
	%\label{#1}
	%\subsection{ \textbf{Przykład \theopenaghexample: #2} }
	% \subsection{ \textbf{\openaghexamplecap \thickspace \theopenaghexample: \openagh@title} }
	\hthree{\openaghexamplecap \thickspace \theopenaghexample: \openagh@title}
	\\
}
{}
\surroundwithmdframed[style=openaghexample_env]{openaghexample}
\fi
\makeatother

% Zadanie
\makeatletter
\ifdefined\HCode
\newenvironment{openaghexercise}[1][title={}]
{%
	\refstepcounter{openaghmoduleexercise}
	\refstepcounter{openaghexercise}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghexercise:\theopenaghmoduleexercise,#1}
	\openaghlabelenvs{\openagh@label}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{<div class="openaghexercise-name">}
	\hthree{\openaghexercisecap \thickspace \theopenaghexercise: \openagh@title}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{</div><br />}
	\HCode{<div class="openaghexercise-data">}
}
{\ifvmode\IgnorePar\fi\EndP\HCode{</div>}}
\else
\newenvironment{openaghexercise}[1][title={}]
{%
	\refstepcounter{openaghmoduleexercise}
	\refstepcounter{openaghexercise}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghexercise:\theopenaghmoduleexercise,#1}
%  \label{#1}
%  \subsection{ \textbf{Podsumowanie \theopenaghsummary: #2} }
 	\openaghlabelenvs{\openagh@label}
  %\label{#1}
	% \subsection{ \textbf{\openaghexercisecap \thickspace \theopenaghexercise: \openagh@title} }
	\hthree{\openaghexercisecap \thickspace \theopenaghexercise: \openagh@title}
	\\
}
{}
\surroundwithmdframed[style=openaghexercise_env]{openaghexercise}
\fi
\makeatother

% Treść zadania
\newenvironment{openaghexecontent}
{%
  \hsix{\openaghexecontentcap:}
}
{}

% Rozwiązanie zadania
\ifdefined\HCode
\newenvironment{openaghexesolution}
{%
  \hsix{\openaghexesolutioncap:}
}
{%
  \\
  \HCode{%
    <button type="button" name="hide">Pokaż rozwiązanie</button>
  }
}
\else
\newenvironment{openaghexesolution}
{%
  \hsix{\openaghexesolutioncap:}
}
{}
\fi

% Podsumowanie
\makeatletter
\ifdefined\HCode
\newenvironment{openaghsummary}[1][title={}]
{%
	\refstepcounter{openaghmodulesummary}
	\refstepcounter{openaghsummary}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghsummary:\theopenaghmodulesummary,#1}
	\openaghlabelenvs{\openagh@label}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{<div class="openaghsummary-name">}
	\hthree{\openaghsummarycap \thickspace \theopenaghsummary: \openagh@title}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{</div><br />}
	\HCode{<div class="openaghsummary-data">}
}
{\ifvmode\IgnorePar\fi\EndP\HCode{</div>}}
\else
\newenvironment{openaghsummary}[1][title={}]
{%
	\refstepcounter{openaghmodulesummary}
	\refstepcounter{openaghsummary}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghsummary:\theopenaghmodulesummary,#1}
	%  \label{#1}
	%  \subsection{ \textbf{Podsumowanie \theopenaghsummary: #2} }
	\openaghlabelenvs{\openagh@label}
	% \subsection{\textbf{\openaghsummarycap \thickspace \theopenaghsummary: \openagh@title}}
	\hthree{\openaghsummarycap \thickspace \theopenaghsummary: \openagh@title}
	\\
}
{}
\surroundwithmdframed[style=openaghsummary_env]{openaghsummary}
\fi
\makeatother

% Wniosek
\makeatletter
\ifdefined\HCode
\newenvironment{openaghconclusion}[1][title={}]
{%
	\refstepcounter{openaghmoduleconclusion}
	\refstepcounter{openaghconclusion}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghconclusion:\theopenaghmoduleconclusion,#1}
	\openaghlabelenvs{\openagh@label}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{<div class="openaghconclusion-name">}
	\hthree{\openaghconclusioncap \thickspace \theopenaghconclusion: \openagh@title}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{</div><br />}
	\HCode{<div class="openaghconclusion-data">}
}
{\ifvmode\IgnorePar\fi\EndP\HCode{</div>}}
\else
\newenvironment{openaghconclusion}[1][title={}]
{%
	\refstepcounter{openaghmoduleconclusion}
	\refstepcounter{openaghconclusion}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghconclusion:\theopenaghmoduleconclusion,#1}
	%  \label{#1}
	% \subsection{ \textbf{Wniosek \theopenaghconclusion: #2} }
	\openaghlabelenvs{\openagh@label}
	% \subsection{\textbf{\openaghconclusioncap \thickspace \theopenaghconclusion: \openagh@title}}
	\hthree{\openaghconclusioncap \thickspace \theopenaghconclusion: \openagh@title}
	\\
}
{}
\surroundwithmdframed[style=openaghconclusion_env]{openaghconclusion}
\fi
\makeatother

% Informacja dodatkowa
\makeatletter
\ifdefined\HCode
\newenvironment{openaghinformation}[1][title={}]
{%
	\refstepcounter{openaghmoduleinformation}
	\refstepcounter{openaghinformation}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghinformation:\theopenaghmoduleinformation,#1}
	\openaghlabelenvs{\openagh@label}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{<div class="openaghinformation-name">}
	\hthree{\openaghinformationcap \thickspace \theopenaghinformation: \openagh@title}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{</div><br />}
	\HCode{<div class="openaghinformation-data">}
}
{\ifvmode\IgnorePar\fi\EndP\HCode{</div>}}
\else
\newenvironment{openaghinformation}[1][title={}]
{%
	\refstepcounter{openaghmoduleinformation}
	\refstepcounter{openaghinformation}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghinformation:\theopenaghmoduleinformation,#1}
	%\label{#1}
	\openaghlabelenvs{\openagh@label}
	%\subsection{ \textbf{Informacja dodatkowa \theopenaghinformation: #2} }
	% \subsection{\textbf{\openaghinformationcap \thickspace \theopenaghinformation: \openagh@title}}
	\hthree{\openaghinformationcap \thickspace \theopenaghinformation: \openagh@title}
	\\
}
{}
\surroundwithmdframed[style=openaghinformation_env]{openaghinformation}
\fi
\makeatother

% Uwaga
\makeatletter
\ifdefined\HCode
\newenvironment{openaghannotation}[1][title={}]
{%
	\refstepcounter{openaghmoduleannotation}
	\refstepcounter{openaghannotation}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghannotation:\theopenaghmoduleannotation,#1}
	\openaghlabelenvs{\openagh@label}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{<div class="openaghannotation-name">}
	\hthree{\openaghannotationcap \thickspace \theopenaghannotation: \openagh@title}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{</div><br />}
	\HCode{<div class="openaghannotation-data">}
}
{\ifvmode\IgnorePar\fi\EndP\HCode{</div>}}
\else
\newenvironment{openaghannotation}[1][title={}]
{%
	\refstepcounter{openaghmoduleannotation}
	\refstepcounter{openaghannotation}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghannotation:\theopenaghmoduleannotation,#1}
	%\label{#1}
	\openaghlabelenvs{\openagh@label}
	%\subsection{ \textbf{Uwaga \theopenaghannotation: #2} }
	% \subsection{\textbf{\openaghannotationcap \thickspace \theopenaghannotation: \openagh@title}}
	\hthree{\openaghannotationcap \thickspace \theopenaghannotation: \openagh@title}
	\\
}
{}
\surroundwithmdframed[style=openaghannotation_env]{openaghannotation}
\fi
\makeatother

% Własność
\makeatletter
\ifdefined\HCode
\newenvironment{openaghproperty}[1][title={}]
{%
	\refstepcounter{openaghmoduleproperty}
	\refstepcounter{openaghproperty}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghproperty:\theopenaghmoduleproperty,#1}
	\openaghlabelenvs{\openagh@label}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{<div class="openaghproperty-name">}
	\hthree{\openaghpropertycap \thickspace \theopenaghproperty: \openagh@title}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{</div><br />}
	\HCode{<div class="openaghproperty-data">}
}
{\ifvmode\IgnorePar\fi\EndP\HCode{</div>}}
\else
\newenvironment{openaghproperty}[1][title={}]
{%
	\refstepcounter{openaghmoduleproperty}
	\refstepcounter{openaghproperty}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghproperty:\theopenaghmoduleproperty,#1}
	\openaghlabelenvs{\openagh@label}
	%\label{#1}
	%\subsection{ \textbf{Własność \theopenaghproperty: #2} }
	% \subsection{\textbf{\openaghpropertycap \thickspace \theopenaghproperty: \openagh@title}}
	\hthree{\openaghpropertycap \thickspace \theopenaghproperty: \openagh@title}
	\\
}
{}
\surroundwithmdframed[style=openaghproperty_env]{openaghproperty}
\fi
\makeatother

% Algorytm
\makeatletter
\ifdefined\HCode
\newenvironment{openaghalgorithm}[1][title={}]
{%
	%\refstepcounter{openaghalgorithm}
	%\label{#1}
	%\subsection{ \textbf{Algorytm \thickspace \theopenaghalgorithm: #2} }
	\refstepcounter{openaghmodulealgorithm}
	\refstepcounter{openaghalgorithm}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghalgorithm:\theopenaghmodulealgorithm,#1}
	\openaghlabelenvs{\openagh@label}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{<div class="openaghalgorithm-name">}
	\hthree{\openaghalgorithmcap \thickspace \theopenaghalgorithm: \openagh@title}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{</div><br />}
	\HCode{<div class="openaghalgorithm-data">}
}
{\ifvmode\IgnorePar\fi\EndP\HCode{</div>}}
\else
\newenvironment{openaghalgorithm}[1][title={}]
{%
	%\refstepcounter{openaghalgorithm}
	%\label{#1}
	%\subsection{ \textbf{Algorytm \thickspace \theopenaghalgorithm: #2} }
	\refstepcounter{openaghmodulealgorithm}
	\refstepcounter{openaghalgorithm}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghalgorithm:\theopenaghmodulealgorithm,#1}
	%  \label{\openagh@label}
	\openaghlabelenvs{\openagh@label}
	% \subsection{\textbf{\openaghalgorithmcap \thickspace \theopenaghalgorithm: \openagh@title}}
	\hthree{\openaghalgorithmcap \thickspace \theopenaghalgorithm: \openagh@title}
	\\
}
{}
\surroundwithmdframed[style=openaghalgorithm_env]{openaghalgorithm}
\fi
\makeatother

% Model
\makeatletter
\ifdefined\HCode
\newenvironment{openaghmodel}[1][title={}]
{%
	\refstepcounter{openaghmodulemodel}
	\refstepcounter{openaghmodel}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghmodel:\theopenaghmodulemodel,#1}
	\openaghlabelenvs{\openagh@label}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{<div class="openaghmodel-name">}
	\hthree{\openaghmodelcap \thickspace \theopenaghmodel: \openagh@title}
	\ifvmode\IgnorePar\fi\EndP
	\HCode{</div><br />}
	\HCode{<div class="openaghmodel-data">}
}
{\ifvmode\IgnorePar\fi\EndP\HCode{</div>}}
\else
\newenvironment{openaghmodel}[1][title={}]
{%
	\refstepcounter{openaghmodulemodel}
	\refstepcounter{openaghmodel}
	\setkeys{openagh@keys}{title={},label=openaghmod:\modid:openaghmodel:\theopenaghmodulemodel,#1}
	%  \label{\openagh@label}
	\openaghlabelenvs{\openagh@label}
	% \subsection{\textbf{\openaghmodelcap \thickspace \theopenaghmodel: \openagh@title}}
	\hthree{\openaghmodelcap \thickspace \theopenaghmodel: \openagh@title}
	\\
}
{}
\surroundwithmdframed[style=openaghmodel_env]{openaghmodel}
\fi
\makeatother

% ######### Bibliografia #########
% Bibliografia

% Przypis - \note{}

% Pokaż przypisy - latex generuje automatycznie

